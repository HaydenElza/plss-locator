<!DOCTYPE html>
<html>
  <head>
    <title>PLSS Locator</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://cartodb-libs.global.ssl.fastly.net/carto.js/v4.1.11/carto.min.js"></script>
    <!-- Include Jquery -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="crossorigin="anonymous"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" type="text/css">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
      * { margin:0; padding:0; }
      html { box-sizing:border-box; height:100%; }
      body { background:#f2f6f9; height:100%; font-family:"Open sans", Helvetica, Arial, sans-serif; }
      #map { 
        position: absolute;
        height: 100%;
        width: 100%;
      }
      #widgets {
        z-index: 999;
        border: solid #babac3 10px;
        background:white;
        padding:10px;
        margin-top: 10px;
      }
      #widgets .output {
        margin-bottom: 0;
      }
      #widgets-container .row {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="widgets-container">
      <div class="row">
        <div id="widgets" class="offset-lg-9 col-lg-3 offset-md-8 col-md-4 offset-sm-6 col-sm-6 offset-3 col-9">
          <button id="get-device-location" class="col-12" onclick="getLocation()">Get Device Location</button>
          <br><br>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="basemapToggle">
            <label class="custom-control-label" for="basemapToggle">Toggle Satellite</label>
          </div>
          <br>
          <h3>Section</h3>
          <p class="output">-----</p>
        </div>
      </div>
    </div>
    <script>
      // Set initial map view
      const map = L.map('map').setView([45,-90], 7);
      map.createPane("backgroundPane").style.zIndex = 100;
      map.createPane("foregroundPane").style.zIndex = 200;
      
      // OSM Basemap
      var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        pane:'backgroundPane'
      }).addTo(map);

      map.addLayer(osm);

      // Google Satellite Basemap
      var google = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
          maxZoom: 20,
          subdomains:['mt0','mt1','mt2','mt3'],
          pane:'backgroundPane'
      });

      // Init client
      var client = new carto.Client({
        apiKey: 'x8vPLNqzI5hRLT6RV-922Q',
        username: 'sco-admin'
      });

      $(document).ready(function() {

        $('#basemapToggle').click(function() {
          if(this.checked) {
            map.removeLayer(osm);
            map.addLayer(google);
          } else {
            map.removeLayer(google);
            map.addLayer(osm);
          }    
        });
      });

      // Prep townships
      const townshipsSource = new carto.source.SQL(`
        SELECT *, 
        CASE
          WHEN dir=2 THEN 'W'
            WHEN dir=4 THEN 'E'
            ELSE NULL
        END AS west_east
        FROM "sco-admin".scobase_wi_plss_townships_24k
      `);
      const sectionsSource = new carto.source.SQL(`
        SELECT * 
        FROM "sco-admin".scobase_wi_plss_sections_24k
      `);
      const qsectionsSource = new carto.source.SQL(`
        SELECT *,
        CASE
          WHEN q=1 THEN 'NE'
            WHEN q=2 THEN 'NW'
            WHEN q=3 THEN 'SW'
            WHEN q=4 THEN 'SE'
            ELSE NULL
        END AS q_text
        FROM "sco-admin".scobase_wi_plss_qsections_24k
      `);
      const qqsectionsSource = new carto.source.SQL(`
        SELECT *, 
        CASE
          WHEN d=2 THEN 'W'
            WHEN d=4 THEN 'E'
            ELSE NULL
        END AS dir,
        CASE
          WHEN q=1 THEN 'NE'
          WHEN q=2 THEN 'NW'
          WHEN q=3 THEN 'SW'
          WHEN q=4 THEN 'SE'
          ELSE NULL
        END AS q_text,
        CASE
          WHEN qq=1 THEN 'NE'
          WHEN qq=2 THEN 'NW'
          WHEN qq=3 THEN 'SW'
          WHEN qq=4 THEN 'SE'
          ELSE NULL
        END AS qq_text
        FROM "sco-admin".scobase_wi_plss_qqsections_24k
      `);

      const townshipsStyle = new carto.style.CartoCSS(`
        #layer {
          polygon-fill: #162945;
          polygon-opacity: 0;

          ::outline {
            line-width: 4;
            line-color: #000;
            line-opacity: 0.25;

            [zoom<9] {
              line-opacity: 0;
            }
          }

          ::labels {
            [zoom>=11][zoom<13] {
              text-size: 20;
              text-name: 'TWP '+[twp]+' N\\nRNG '+[rng]+' '+[west_east];
              text-face-name: 'Lato Bold';
              text-fill: #465159;
              text-label-position-tolerance: 0;
              text-halo-radius: 1.5;
              text-halo-fill: #FFFFFF;
              text-allow-overlap: true;
              text-placement: point;
              text-placement-type: dummy;
            }
          }
        }
      `);

      const sectionsStyle = new carto.style.CartoCSS(`
        #layer {
          polygon-fill: #162945;
          polygon-opacity: 0;
          ::outline {
            line-width: 2;
            line-color: #000; /* dcdfe3 */
            line-opacity: 0.25;

            [zoom<13] {
              line-opacity: 0;
            }
          }
          
          ::labels {
            [zoom>=13] {
              text-size: 20;
              text-name: 'SEC\\n'+[sec];
              text-face-name: 'Lato Bold';
              text-fill: #465159;
              text-label-position-tolerance: 0;
              text-halo-radius: 1.5;
              text-halo-fill: #FFFFFF;
              text-allow-overlap: true;
              text-placement: point;
              text-placement-type: dummy;
            }
            [zoom>=14] {
              text-size: 36;
            }
            [zoom>=15] {
              text-size: 52;
            }
            [zoom>=16] {
              text-size: 72;
            }
          }
        }
      `);

      const qsectionsStyle = new carto.style.CartoCSS(`
        #layer {
          polygon-fill: #162945;
          polygon-opacity: 0;
          ::outline {
            line-width: 1;
            line-color: #727d85;
            line-opacity: 0.25;

            [zoom<14] {
              line-opacity: 0;
            }
          }
          
          ::labels {
            [zoom>=14] {
              text-size: 20;
              text-name: '[q_text]';
              text-face-name: 'Lato Bold';
              text-fill: #727d85;
              text-label-position-tolerance: 0;
              text-halo-radius: 1.5;
              text-halo-fill: #FFFFFF;
              text-allow-overlap: true;
              text-placement: point;
              text-placement-type: dummy;
            }
            [zoom>=15] {
              text-size: 36;
            }
            [zoom>=16] {
              text-size: 52;
            }
          }
        }
      `);

      const qqsectionsStyle = new carto.style.CartoCSS(`
        #layer {
          polygon-fill: #162945;
          polygon-opacity: 0;
          ::outline {
            line-width: 1;
            line-color: #99a2a8;
            line-opacity: 0.25;
            line-dasharray: 8,16;

            [zoom<15] {
              line-opacity: 0;
            }
          }
          
          ::labels {
            [zoom>=15] {
              text-size: 20;
              text-name: [qq_text];
              text-face-name: 'Lato Bold';
              text-fill: #99a2a8;
              text-label-position-tolerance: 0;
              text-halo-radius: 1.5;
              text-halo-fill: #FFFFFF;
              text-allow-overlap: true;
              text-placement: point;
              text-placement-type: dummy;
            }
            [zoom>=17] {
              text-size: 36;
            }
            [zoom>=19] {
              text-size: 52;
            }
          }
        }
      `);



      const townships = new carto.layer.Layer(townshipsSource, townshipsStyle, {});

      const sections = new carto.layer.Layer(sectionsSource, sectionsStyle, {});

      const qsections = new carto.layer.Layer(qsectionsSource, qsectionsStyle, {});

      const qqsections = new carto.layer.Layer(qqsectionsSource, qqsectionsStyle, {});

      // Add qqsections layer
      client.addLayers([qqsections],{pane:'foregroundPane'});
      client.getLeafletLayer().addTo(map);

      // Add qsections layer
      client.addLayers([qsections],{pane:'foregroundPane'});
      client.getLeafletLayer().addTo(map);

      // Add sections layer
      client.addLayers([sections],{pane:'foregroundPane'});
      client.getLeafletLayer().addTo(map);

      // Add townships layer
      client.addLayers([townships],{pane:'foregroundPane'});
      client.getLeafletLayer().addTo(map);

      // Add empty layer to add selected features into
      var selectedStyle = {
        "color": "#e8b756",
        "fillOpacity": 0.1,
        "weight": 4,
        "opacity": 0.75
        
      };
      var selectedFeatures = L.geoJson(null,{style: selectedStyle}).addTo(map);

      // Get location from device
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var latlng = L.latLng(position.coords.latitude,position.coords.longitude);

            get_twp_sec(latlng);

            // Fly to location on map
            map.flyTo(latlng, 15,{
              animate: true,
              duration: 0.5
            });
          });
        } else { 
          $('.output').text("Geolocation is not supported by this browser.");
        }
      }
      
      // Set Global Variable that will hold the marker that goes at our location when found
      var locationMarker = null;

      // Set marker icon
      var redIcon = L.icon({
        iconUrl: 'images/redIcon.png',
        shadowUrl: 'images/marker-shadow.png',
        iconAnchor: [13, 41]
      });

      // Listen for a click event on the Map element
      map.on('click', function(e){
        addMarker(e.latlng);
        selectFeatures(e.latlng);
      });

      function addMarker(latlng) {
        // remove locationMarker if on map
        if(map.hasLayer(locationMarker)){
          map.removeLayer(locationMarker);
        };

        locationMarker = L.marker(latlng, {icon: redIcon});
        map.addLayer(locationMarker); 
      }

      function selectFeatures(latlng) {
        selectedFeatures.clearLayers();

        $.getJSON(`https://sco-admin.carto.com/api/v2/sql?format=GEOJSON&q=SELECT * FROM "sco-admin".scobase_wi_plss_townships_24k WHERE ST_Contains(the_geom, ST_GeomFromText('POINT(`+latlng.lng+` `+latlng.lat+`)',4326));`, function(data) {
          selectedFeatures.addData(data);
        });
        $.getJSON(`https://sco-admin.carto.com/api/v2/sql?format=GEOJSON&q=SELECT * FROM "sco-admin".scobase_wi_plss_sections_24k WHERE ST_Contains(the_geom, ST_GeomFromText('POINT(`+latlng.lng+` `+latlng.lat+`)',4326));`, function(data) {
          selectedFeatures.addData(data);
        });
        $.getJSON(`https://sco-admin.carto.com/api/v2/sql?format=GEOJSON&q=SELECT * FROM "sco-admin".scobase_wi_plss_qsections_24k WHERE ST_Contains(the_geom, ST_GeomFromText('POINT(`+latlng.lng+` `+latlng.lat+`)',4326));`, function(data) {
          selectedFeatures.addData(data);
        });
        $.getJSON(`https://sco-admin.carto.com/api/v2/sql?format=GEOJSON&q=SELECT *, CASE WHEN d=2 THEN 'W'WHEN d=4 THEN 'E'ELSE NULL END AS dir, CASE WHEN q=1 THEN 'NE'WHEN q=2 THEN 'NW'WHEN q=3 THEN 'SW'WHEN q=4 THEN 'SE'ELSE NULL END AS q_text, CASE WHEN qq=1 THEN 'NE'WHEN qq=2 THEN 'NW'WHEN qq=3 THEN 'SW'WHEN qq=4 THEN 'SE'ELSE NULL END AS qq_text FROM "sco-admin".scobase_wi_plss_qqsections_24k as qqsec WHERE ST_Contains(the_geom, ST_GeomFromText('POINT(`+latlng.lng+` `+latlng.lat+`)',4326));`, function(data) {
          selectedFeatures.addData(data);

          var properties = data.features[0].properties
          var dir = properties.dir.toString();
          var twp = properties.t.toString();
          var rng = properties.r.toString();
          var sec = properties.s.toString();
          var q   = properties.q_text.toString();
          var qq  = properties.qq_text.toString();

          var infoString = "Township: " + twp + " N" + 
            "<br>Range: " + rng + dir + 
            "<br>Section: " + sec + 
            "<br>Quarter Section: " + q +
            "<br>Quarter Quarter Section: " + qq;

          $('.output').html(infoString)
        });
      }

      // Get the township and section from latitude and longitude
      function get_twp_sec(latlng) {
        addMarker(latlng);
        selectFeatures(latlng);
      }

    </script>
  </body>
</html>