<!DOCTYPE html>
<html>
<head>
	<title>PLSS Locator</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Turf.js -->
	<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

	<!-- Jquery -->
	<script
		src="https://code.jquery.com/jquery-3.4.1.min.js"
		integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
		crossorigin="anonymous"></script>

	<!-- Sections Dataset -->
	<script src='sections.js'></script>

	<!-- Leaflet -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>

	<style type="text/css">
		body {
			margin: 0;
		}
		form {
			text-align: center;
			margin-left: auto;
			margin-right: auto;
			margin-top: 1em;
		}
		#map {
			position: absolute;
			width: 100%;
			top: 11em;
			bottom: 0;
		}
		input {
			width: 5em;
		}
		#output {
			height: 1em;
			text-align: center;
		}
		#get-device-location {
			display: block;
			margin-left: auto;
			margin-right: auto;
		}
	</style>
</head>
<body>
	<div id="top">
		<form action="">
			<label>Lat:</label>
			<input type="number" name="Latitude" value="43.0731">
			<label>Long:</label>
			<input type="number" name="Longitude" value="-89.4012">
			<button id="submit" type="submit" form="coordinates" value="Submit">Submit</button>
		</form>
		<br>
		<button id="get-device-location" onclick="getLocation()">Get Device Location</button>

		<h3 id="output"></h3>
	</div>

	<div id="map"></div>
	

	<script type="text/javascript">
		// Init map
		init_map()

		// Zoom to WI
		this.leafletMap.fitBounds([
			[42.67435857693381, -92.801513671875],
			[46.882723010671945, -86.868896484375]
		])

		// Get location from lat lon form
		$(document).ready(function() {
			$('#submit').click(function() {
				var lat = $("input[name='Latitude']").val();
				var lon = $("input[name='Longitude']").val();
				get_twp_sec(lat,lon)
			});
		})

		// Get location from device
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					get_twp_sec(position.coords.latitude,position.coords.longitude)
				});
			} else { 
				$('#output').text("Geolocation is not supported by this browser.");
			}
		}

		// Get the township and section from latitude and longitude
		function get_twp_sec(lat,lon) {

			var point = turf.featureCollection( [turf.point([lon,lat])] );

			var tagged = turf.tag(point, sections, 'DTRS', 'dtrs');

			var dtrs = String(tagged.features[0].properties['dtrs']);

			// Convert range direction to text
			var d = parseInt(dtrs/1000000)
			if(dir==2) {var dir = "W"; } else {var dir = "E"; }

			var infoString = "T" + dtrs.substring(1,3) + "N R" + dtrs.substring(3,5) + dir + " S" + dtrs.substring(5,7);

			$('#output').text(infoString)

			update_map(lat,lon,dtrs)
		}

		// Update map
		function init_map () {
			this.leafletMap = new L.map('map');

			// Add baselayer
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(this.leafletMap);
		}

		// Insert map
		function update_map(lat,lon,dtrs) {

			this.leafletMap.remove()

			init_map()

			// Add sections
			var sectionStyle = {
				"fillOpacity": 0,
				"color": "#000",
				"weight": 5,
				"opacity": 0.7
			};
			var sectionsLayer = L.geoJSON(sections, {style: sectionStyle, filter: sectionFilter}).addTo(this.leafletMap);

			function sectionFilter(feature) {
				if (feature.properties.DTRS == dtrs) return true
			}

			// Add marker and set view to location
			var marker = L.marker([lat,lon], {}).addTo(this.leafletMap);
			this.leafletMap.setView([lat,lon], 15)

		}
		

	</script>

</body>
</html>