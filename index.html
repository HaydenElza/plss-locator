<!DOCTYPE html>
<html>
  <head>
    <title>PLSS Locator</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://cartodb-libs.global.ssl.fastly.net/carto.js/v4.1.11/carto.min.js"></script>
    <!-- Include Jquery -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="crossorigin="anonymous"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" type="text/css">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
      * { margin:0; padding:0; }
      html { box-sizing:border-box; height:100%; }
      body { background:#f2f6f9; height:100%; font-family:"Open sans", Helvetica, Arial, sans-serif; }
      #map { 
        position: absolute;
        height: 100%;
        width: 100%;
      }
      #widgets {
        z-index: 999;
        border: solid #babac3 10px;
        background:white;
        padding:10px;
        margin-top: 10px;
      }
      #widgets .output {
        margin-bottom: 0;
      }
      #widgets-container .row {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="widgets-container">
      <div class="row">
        <div id="widgets" class="offset-lg-9 col-lg-3 offset-md-8 col-md-4 offset-sm-6 col-sm-6 offset-3 col-9">
          <button id="get-device-location" class="col-12" onclick="getLocation()">Get Device Location</button>
          <br><br>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="basemapToggle">
            <label class="custom-control-label" for="basemapToggle">Toggle Satellite</label>
          </div>
          <br>
          <h3>Section</h3>
          <p class="output">-----</p>
        </div>
      </div>
    </div>
    <script>
      // Set initial map view
      const map = L.map('map').setView([45,-90], 7);
      map.createPane("backgroundPane").style.zIndex = 100;
      map.createPane("foregroundPane").style.zIndex = 200;
      
      // Voyager Basemap
      var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        pane:'backgroundPane'
      }).addTo(map);

      map.addLayer(osm);

      // Google Satellite Basemap
      var google = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
          maxZoom: 20,
          subdomains:['mt0','mt1','mt2','mt3'],
          pane:'backgroundPane'
      });

      // Adding Voyager Labels
      // L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/light_only_labels/{z}/{x}/{y}.png', {
      //   maxZoom: 18,
      //   zIndex: 10
      // }).addTo(map);

      // Init client
      var client = new carto.Client({
        apiKey: '0dYpf-D3nqmKJfLnAjOmqQ',
        username: 'sco-admin'
      });

      $(document).ready(function() {

        $('#basemapToggle').click(function() {
          if(this.checked) {
            map.removeLayer(osm);
            map.addLayer(google);
          } else {
            map.removeLayer(google);
            map.addLayer(osm);
          }    
        });
      });

      // Prep townships
      const sectionsSource = new carto.source.SQL(`
        SELECT * 
        FROM "sco-admin".scobase_wi_plss_sections_24k
      `);

      const sectionsStyle = new carto.style.CartoCSS(`
        #layer {
          polygon-fill: #162945;
          polygon-opacity: 0;
          ::outline {
            line-width: 2;
            line-color: #dcdfe3;
            line-opacity: 1;
          }
        }
        #layer[zoom<13]::outline {
          line-opacity: 0;
        }
        #layer::labels[zoom>=13] {
          text-size: 20;
          text-name: [dtrs];
          text-face-name: 'Lato Bold';
          text-fill: #465159;
          text-label-position-tolerance: 0;
          text-halo-radius: 1.5;
          text-halo-fill: #FFFFFF;
          text-dy: -10;
          text-allow-overlap: true;
          text-placement: point;
          text-placement-type: dummy;
        }
      `);

      const sections = new carto.layer.Layer(sectionsSource, sectionsStyle, {
        featureClickColumns: ['dtrs']
      });

      // Add townships layer
      client.addLayers([sections],{pane:'foregroundPane'});
      client.getLeafletLayer().addTo(map);

      // Add empty layer to add selected features into
      var selectedFeature = L.geoJson().addTo(map);



      // Get location from device
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var latlng = L.latLng(position.coords.latitude,position.coords.longitude);

            get_twp_sec(latlng);

            // Fly to location on map
            map.flyTo(latlng, 15,{
              animate: true,
              duration: 0.5
            });
          });
        } else { 
          $('.output').text("Geolocation is not supported by this browser.");
        }
      }
      
      // Set Global Variable that will hold the marker that goes at our location when found
      var locationMarker = null;

      // Set marker icon
      var redIcon = L.icon({
        iconUrl: 'images/redIcon.png',
        shadowUrl: 'images/marker-shadow.png',
        iconAnchor: [13, 41]
      });

      // Listen for a click event on the Map element
      map.on('click', function(e){
        addMarker(e.latlng);
        selectSection(e.latlng);
      });

      function addMarker(latlng) {
        // remove locationMarker if on map
        if(map.hasLayer(locationMarker)){
          map.removeLayer(locationMarker);
        };

        locationMarker = L.marker(latlng, {icon: redIcon});
        map.addLayer(locationMarker); 
      }

      function selectSection(latlng) {
        $.getJSON("https://sco-admin.carto.com/api/v2/sql?format=GEOJSON&q=SELECT * FROM \"sco-admin\".scobase_wi_plss_sections_24k as sec WHERE ST_Contains(the_geom, ST_GeomFromText('POINT("+latlng.lng+" "+latlng.lat+")',4326));", function(data) {
          selectedFeature.clearLayers();
          selectedFeature.addData(data);

          var dtrs = data.features[0].properties.dtrs.toString();

          // Convert range direction to text
          var d = parseInt(dtrs/1000000)
          if(dir==2) {var dir = "W"; } else {var dir = "E"; }

          var infoString = "T" + dtrs.substring(1,3) + "N R" + dtrs.substring(3,5) + dir + " S" + dtrs.substring(5,7);

          $('.output').text(infoString)
        });
      }

      // Get the township and section from latitude and longitude
      function get_twp_sec(latlng) {
        addMarker(latlng);
        selectSection(latlng);

        

        // update_map(lat,lon,dtrs)
      }

    </script>
  </body>
</html>